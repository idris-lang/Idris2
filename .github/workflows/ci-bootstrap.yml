# Check bootstrap with the minimum supported Chez Scheme version.

name: Bootstrap

env:
  MIN_CHEZ_VERSION: 9.5.1

on:
  push:
    paths: &paths
      - 'bootstrap/idris2_app/idris2.ss'
      - '.github/workflows/ci-bootstrap.yml'
  pull_request:
    paths: *paths

jobs:
  initialise:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # for pull_request so we can do HEAD^2
          fetch-depth: 2

      - name: Get commit message
        id: get_commit_message
        run: |
          if   [[ '${{ github.event_name }}' == 'push' ]]; then
            echo "commit_message=$(git log --format=%B -n 1 HEAD | tr '\n' ' ')" >> "$GITHUB_OUTPUT"
          elif [[ '${{ github.event_name }}' == 'pull_request' ]]; then
            echo "commit_message=$(git log --format=%B -n 1 HEAD^2 | tr '\n' ' ')" >> "$GITHUB_OUTPUT"
          fi

    outputs:
      commit_message:
        echo "${{ steps.get_commit_message.outputs.commit_message }}"

  bootstrap:
    needs: initialise
    runs-on: ubuntu-24.04
    if: |
      !contains(needs.initialise.outputs.commit_message, '[ci: skip]')
    env:
      IDRIS2_CG: chez
      SCHEME: scheme
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y uuid-dev

      - name: Build and Install Chez Scheme
        run: |
          git clone --depth 1 --branch "v${MIN_CHEZ_VERSION}" https://github.com/cisco/ChezScheme.git
          cd ChezScheme
          # Newer GCC reports maybe-uninitialized in Chez 9.5.1
          ./configure --threads --disable-x11 CFLAGS=-Wno-error=maybe-uninitialized
          make -j$(nproc)
          sudo make install
          cd ..
          rm -rf ChezScheme

      - name: Build bootstrap
        run: make bootstrap
